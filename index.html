<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Levels Admin Panel</title>

<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6f8fa; --card:#fff; --ink:#0f1f28; --muted:#64748b;
    --chip:#e2e8f0; --chip-ink:#0f1f28;
    --btn:#233e57; --btn-ink:#fff; --hover:#e9f5f2;
    --red:#ef4444; --amber:#f59e0b; --green:#16a34a; --blue:#2563eb;
    --radius:16px; --radius-lg:22px; --shadow:0 10px 24px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Red Hat Display", system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .toolbar{background:var(--card);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:18px 18px;display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .toolbar .who{font-weight:600;margin-right:auto}
  select,input[type="date"]{background:#f1f5f9;border:none;border-radius:12px;padding:10px 12px;font-size:14px}
  button{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn{background:var(--btn);color:var(--btn-ink)}
  .muted{color:var(--muted)}
  .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:18px}
  .card{grid-column:1/-1;background:var(--card);box-shadow:var(--shadow);border-radius:var(--radius-lg);padding:0}
  .row{padding:16px 18px;border-top:1px solid #eef2f7}
  .row:first-child{border-top:none}
  .header{display:grid;grid-template-columns: 170px 110px 220px 200px 1fr 150px;gap:12px;padding:14px 18px;font-weight:700;color:var(--muted)}
  .item{display:grid;grid-template-columns: 170px 110px 220px 200px 1fr 150px;gap:12px;align-items:center;padding:10px 18px;border-top:1px solid #eef2f7;cursor:pointer;transition:background .15s}
  .item:hover{background:#fafbfc}
  .item.alert{background:#fff7e6}
  .name{font-weight:800}
  .status-pill{justify-self:end}
  .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:8px 12px;font-weight:800;font-size:13px}
  .pill.amber{background:#fff1c7;color:#b45309}
  .pill.blue{background:#dbeafe;color:#1d4ed8}
  .pill.green{background:#dcfce7;color:#166534}
  .pill.gray{background:#e2e8f0;color:#111827}
  .details{padding:12px 18px 18px 18px;border-top:1px dashed #e5e7eb}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .kv{background:#f8fafc;border-radius:12px;padding:12px}
  .kv .t{color:var(--muted);font-weight:700;font-size:13px;margin-bottom:4px}
  .kv .v{font-weight:700}
  .actions{display:flex;gap:10px;margin-top:12px}
  .danger{background:#fee2e2;color:#991b1b}
  .dropdown{position:relative;display:inline-block}
  .menu{position:absolute;z-index:50;right:0;top:100%;margin-top:6px;background:#fff;border-radius:12px;box-shadow:var(--shadow);min-width:180px;display:none;overflow:hidden}
  .menu.show{display:block}
  .menu button{display:block;width:100%;background:#fff;color:#111827;text-align:left;border-radius:0;padding:10px 12px}
  .menu button:hover{background:#f1f5f9}
  .badge{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border-radius:999px;padding:6px 10px;font-size:12px}
  .badge .dot{width:8px;height:8px;border-radius:999px;background:var(--amber)}
  .form-tabs{display:flex;gap:10px;margin:16px 0 8px 0}
  .tab{background:#eef2f7;border:none;border-radius:12px;padding:8px 12px;cursor:pointer}
  .tab.active{background:#dbeafe;color:#1d4ed8;font-weight:800}
  .center{display:flex;justify-content:center;align-items:center;padding:24px}
  .login{max-width:380px;margin:64px auto;background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:22px}
  .login h1{margin:0 0 8px 0}
  .login .row{display:flex;flex-direction:column;gap:6px;border-top:none}
  .login input{width:100%}
  .error{color:#b91c1c;font-weight:700}
  .errbar{display:none;margin:12px 0;padding:12px 14px;border-radius:12px;background:#fef2f2;color:#991b1b;font-weight:700}
  .errbar a{color:#991b1b;text-decoration:underline}
</style>
</head>
<body>
<div class="wrap" id="app">
  <!-- Login -->
  <div id="loginView" class="login" style="display:none">
    <h1>Admin sign in</h1>
    <div class="muted">Use your Firebase email & password</div>
    <div class="row">
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="you@example.com"/>
    </div>
    <div class="row">
      <label>Password</label>
      <input id="loginPass" type="password" placeholder="********"/>
    </div>
    <div class="row" style="gap:10px">
      <button class="btn" id="loginBtn">Sign in</button>
      <div class="error" id="loginErr" style="display:none"></div>
    </div>
  </div>

  <!-- Main -->
  <div id="mainView" style="display:none">
    <div class="toolbar">
      <div class="who" id="whoBox">Signed in</div>

      <div class="badge" id="allNewBadge" title="Items needing action across all forms">
        <span class="dot"></span><span id="allNewCount">0</span>
      </div>

      <select id="branchSel">
        <option value="">All branches</option>
        <option value="vake">Vake</option>
        <option value="krtsanisi">Krtsanisi</option>
      </select>

      <select id="statusSel">
        <option value="">All statuses</option>
        <option value="action_required">Action required</option>
        <option value="contacted">Contacted</option>
        <option value="registered">Registered</option>
      </select>

      <input id="fromDate" type="date"/>
      <input id="toDate" type="date"/>

      <button class="btn" id="applyBtn">Apply</button>
      <button id="resetBtn">Reset</button>
      <button id="signOutBtn">Sign out</button>
    </div>

    <div id="errbar" class="errbar"></div>

    <div class="form-tabs">
      <button class="tab active" data-form="">All</button>
      <button class="tab" data-form="EnglishRegistration">English</button>
      <button class="tab" data-form="ArtRegistration">Art</button>
      <button class="tab" data-form="SummerSchool">Summer school</button>
      <button class="tab" data-form="StudyAbroad">Study abroad</button>
      <button class="tab" data-form="CorporateEnroll">Corporate</button>
    </div>

    <div class="cards">
      <div class="card">
        <div class="header">
          <div>Created</div>
          <div>Branch</div>
          <div>Name</div>
          <div>Form</div>
          <div>Course / School</div>
          <div class="status-pill">Status</div>
        </div>
        <div id="list"></div>
        <div id="empty" class="center muted" style="display:none">No results.</div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, where, orderBy, limit, getDocs, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  /* ===== Firebase config ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyB-vfjAb9matVnpO6BVc3xBoFHnT_xXfH0",
    authDomain: "levels-registration.firebaseapp.com",
    projectId: "levels-registration",
    storageBucket: "levels-registration.firebasestorage.app",
    messagingSenderId: "883788306190",
    appId: "1:883788306190:web:1da45dc034cca9edefa95f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /* ===== Helpers ===== */
  const BRANCH_MAP = { 'vake':'Vake','krtsanisi':'Krtsanisi','ვაკე':'Vake','კრწანისი':'Krtsanisi' };
  const BRANCH_KEY = { 'Vake':'vake','Krtsanisi':'krtsanisi','ვაკე':'vake','კრწანისი':'krtsanisi' };
  const FORM_LABEL = {
    EnglishRegistration:'English registration',
    ArtRegistration:'Art registration',
    SummerSchool:'Summer school',
    StudyAbroad:'Study abroad',
    CorporateEnroll:'Corporate'
  };
  const toDateStr = (ts) => {
    if (!ts) return '';
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString();
  };
  const pill = (status) => {
    if(status==='registered') return '<span class="pill green">Registered</span>';
    if(status==='contacted') return '<span class="pill blue">Contacted</span>';
    return '<span class="pill amber">Action required</span>';
  };

  const errbar = document.getElementById('errbar');
  const showError = (msg, link) => {
    errbar.innerHTML = link ? `${msg} — <a href="${link}" target="_blank" rel="noopener">Create index</a>` : msg;
    errbar.style.display = 'block';
  };
  const clearError = () => { errbar.style.display = 'none'; errbar.textContent = ''; };

  /* ===== State ===== */
  let activeForm = '';          // '' = All
  let branchSel = '';           // '' = All
  let statusSel = '';           // '' = All
  let fromDate = '';            // '' = none
  let toDate = '';              // '' = none

  /* ===== UI refs ===== */
  const loginView = document.getElementById('loginView');
  const mainView  = document.getElementById('mainView');
  const loginBtn  = document.getElementById('loginBtn');
  const loginErr  = document.getElementById('loginErr');
  const whoBox    = document.getElementById('whoBox');
  const listEl    = document.getElementById('list');
  const emptyEl   = document.getElementById('empty');
  const allNewCount = document.getElementById('allNewCount');

  /* ===== Auth flow ===== */
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      mainView.style.display='none';
      loginView.style.display='block';
      return;
    }
    // check admin
    const email = (user.email||'').toLowerCase();
    const adminDoc = await getDoc(doc(db,'admins',email));
    if (!adminDoc.exists() || (adminDoc.data().role!=='admin')) {
      mainView.style.display='none';
      loginView.style.display='block';
      loginErr.style.display='block';
      loginErr.textContent = `You are not authorized (missing /admins/${email} with role "admin").`;
      await signOut(auth);
      return;
    }
    loginView.style.display='none';
    mainView.style.display='block';
    whoBox.textContent = `Signed in as ${email} (admin)`;
    await refreshCounts();
    await load();  // initial load
  });

  loginBtn.onclick = async () => {
    loginErr.style.display='none';
    const email = (document.getElementById('loginEmail').value||'').trim();
    const pass  = document.getElementById('loginPass').value||'';
    try{
      await signInWithEmailAndPassword(auth,email,pass);
    }catch(e){
      loginErr.style.display='block';
      loginErr.textContent = e.message || String(e);
    }
  };
  document.getElementById('signOutBtn').onclick = ()=>signOut(auth);

  /* ===== Filters / Tabs ===== */
  document.querySelectorAll('.tab').forEach(b=>{
    b.addEventListener('click', async ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      b.classList.add('active');
      activeForm = b.dataset.form || '';
      await load();
    });
  });

  document.getElementById('applyBtn').onclick = async () => {
    branchSel = document.getElementById('branchSel').value || '';
    statusSel = document.getElementById('statusSel').value || '';
    fromDate  = document.getElementById('fromDate').value || '';
    toDate    = document.getElementById('toDate').value || '';
    await load();
  };
  document.getElementById('resetBtn').onclick = async () => {
    document.getElementById('branchSel').value='';
    document.getElementById('statusSel').value='';
    document.getElementById('fromDate').value='';
    document.getElementById('toDate').value='';
    branchSel=statusSel=fromDate=toDate='';
    await load();
  };

  /* ===== Queries (safe for legacy docs) ===== */
  function toTSStart(iso){ return iso ? Timestamp.fromDate(new Date(iso+'T00:00:00')) : null; }
  function toTSEnd(iso){   return iso ? Timestamp.fromDate(new Date(iso+'T23:59:59')) : null; }
  function inRange(ts, fromTS, toTS){
    if (!ts) return true;
    const s = ts.seconds || Math.floor((new Date(ts)).getTime()/1000);
    if (fromTS && s < fromTS.seconds) return false;
    if (toTS && s > toTS.seconds) return false;
    return true;
    }

  async function runQuery(formKey, branchKey, status, fromISO, toISO, pageLimit=300){
    const col = collection(db,'submissions');
    const fromTS = toTSStart(fromISO);
    const toTS   = toTSEnd(toISO);

    // --- NEW documents (formKey/branchKey) - fully indexed and fast
    const newWhere = [];
    if (formKey)   newWhere.push(['formKey','==',formKey]);
    if (branchKey) newWhere.push(['branchKey','==',branchKey]);
    if (status)    newWhere.push(['status','==',status]);

    let qNew = query(col);
    newWhere.forEach(w => qNew = query(qNew, where(...w)));
    if (fromTS) qNew = query(qNew, where('createdAt','>=',fromTS));
    if (toTS)   qNew = query(qNew, where('createdAt','<=',toTS));
    qNew = query(qNew, orderBy('createdAt','desc'), limit(pageLimit));

    // --- LEGACY documents (formId/branch) - avoid composite indexes
    // We fetch with 0 or 1 equality filter and then filter client-side.
    const legacyPromises = [];
    if (formKey){
      legacyPromises.push(getDocs(query(col, where('formId','==',formKey), limit(pageLimit))));
    }else if (branchKey){
      const labels = branchKey==='vake' ? ['Vake','ვაკე'] : ['Krtsanisi','კრწანისი'];
      for (const b of labels){
        legacyPromises.push(getDocs(query(col, where('branch','==',b), limit(pageLimit))));
      }
    }else{
      // All forms, no branch filter — pull a recent window by status if set, else by createdAt.
      if (status){
        legacyPromises.push(getDocs(query(col, where('status','==',status), limit(pageLimit))));
      }else{
        // no filters -> keep reads sane by ordering + limiting
        legacyPromises.push(getDocs(query(col, orderBy('createdAt','desc'), limit(pageLimit))));
      }
    }

    const out = [];
    const seen = new Set();

    // Fetch new docs (will throw if a rare index is still missing)
    try{
      const snap = await getDocs(qNew);
      snap.forEach(d=>{
        if (seen.has(d.id)) return; seen.add(d.id);
        out.push({id:d.id, ...d.data()});
      });
    }catch(e){
      // Surface the index link if present but still continue with legacy results
      const link = e?.message?.includes('https://console.firebase.google.com') ? e.message.match(/https:[^\s)]+/)[0] : '';
      showError('Some results need a new index for faster queries.', link);
    }

    // Fetch legacy sets and filter client-side
    const snaps = await Promise.allSettled(legacyPromises);
    const fromR = fromTS?.seconds, toR = toTS?.seconds;
    const wantBranchLabels = branchKey ? (branchKey==='vake' ? ['Vake','ვაკე'] : ['Krtsanisi','კრწანისი']) : null;

    for (const s of snaps){
      if (s.status !== 'fulfilled') continue;
      s.value.forEach(d=>{
        if (seen.has(d.id)) return;
        const v = d.data();
        // form filter
        if (formKey && !(v.formId===formKey)) return;
        // status filter
        if (status && v.status!==status) return;
        // branch filter on legacy labels
        if (wantBranchLabels && !wantBranchLabels.includes(v.branch)) return;
        // date filter
        const secs = v.createdAt?.seconds;
        if (fromR && (!secs || secs < fromR)) return;
        if (toR && (!secs || secs > toR)) return;

        seen.add(d.id);
        out.push({id:d.id, ...v});
      });
    }

    // final sort newest first
    out.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    return out;
  }

  async function refreshCounts(){
    // fast count: new+legacy share 'status'
    const col = collection(db,'submissions');
    const snap = await getDocs(query(col, where('status','==','action_required'), orderBy('createdAt','desc'), limit(200)));
    allNewCount.textContent = snap.size || 0;
  }

  async function load(){
    clearError();
    listEl.innerHTML = '<div class="center muted">Loading…</div>';
    try{
      const rows = await runQuery(activeForm, (branchSel||''), (statusSel||''), fromDate, toDate);
      render(rows);
    }catch(e){
      const link = e?.message?.includes('https://console.firebase.google.com') ? e.message.match(/https:[^\s)]+/)[0] : '';
      showError('Query failed.', link);
      render([]); // at least clear the loader
    }
  }

  /* ===== Render ===== */
  function render(rows){
    if (!rows.length){
      listEl.innerHTML = '';
      emptyEl.style.display='block';
      return;
    }
    emptyEl.style.display='none';
    const html = rows.map(r=>{
      const created = toDateStr(r.createdAt);
      const branch  = r.branchKey ? (BRANCH_MAP[r.branchKey]||r.branchKey) : (r.branch||'');
      const name    = [r.firstName,r.lastName].filter(Boolean).join(' ');
      const formLbl = FORM_LABEL[r.formKey||r.formId] || (r.form || (r.formId||r.formKey||''));
      const course  = r.course || r.school || '';
      const alert   = (r.status||'action_required')==='action_required' ? 'alert' : '';
      return `
        <div class="item ${alert}" data-id="${r.id}">
          <div>${created||''}</div>
          <div>${branch||''}</div>
          <div class="name">${name||''}</div>
          <div>${formLbl}</div>
          <div>${course||''}</div>
          <div class="status-pill">${pill(r.status||'action_required')}</div>
        </div>
        <div class="details" id="det-${r.id}" style="display:none">
          <div class="grid">
            <div class="kv"><div class="t">Email</div><div class="v">${r.email||''}</div></div>
            <div class="kv"><div class="t">Phone</div><div class="v">${r.phoneE164||''}</div></div>
            <div class="kv"><div class="t">Age</div><div class="v">${(r.age??'')}</div></div>
            <div class="kv" style="grid-column:1/-1">
              <div class="t">Message</div><div class="v">${r.message||''}</div>
            </div>
          </div>
          <div class="actions">
            <div class="dropdown">
              <button class="pill gray" data-dd="${r.id}">Change status ▾</button>
              <div class="menu" id="menu-${r.id}">
                <button data-set="action_required" data-for="${r.id}">Action required</button>
                <button data-set="contacted" data-for="${r.id}">Contacted</button>
                <button data-set="registered" data-for="${r.id}">Registered</button>
              </div>
            </div>
            <button class="danger" data-del="${r.id}">Delete</button>
          </div>
        </div>
      `;
    }).join('');
    listEl.innerHTML = html;

    // expand/collapse
    listEl.querySelectorAll('.item').forEach(el=>{
      el.addEventListener('click', ()=>{
        const id = el.dataset.id;
        const det = document.getElementById('det-'+id);
        det.style.display = det.style.display==='none' ? 'block' : 'none';
      });
    });

    // dropdown status menus
    listEl.querySelectorAll('[data-dd]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute('data-dd');
        document.getElementById('menu-'+id).classList.toggle('show');
      });
    });
    document.addEventListener('click', ()=>{
      document.querySelectorAll('.menu.show').forEach(m=> m.classList.remove('show'));
    });

    // set status
    listEl.querySelectorAll('[data-set]').forEach(b=>{
      b.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const id = b.getAttribute('data-for');
        const val = b.getAttribute('data-set');
        await updateDoc(doc(db,'submissions',id), { status: val });
        await refreshCounts();
        await load();
      });
    });

    // delete
    listEl.querySelectorAll('[data-del]').forEach(b=>{
      b.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const id = b.getAttribute('data-del');
        if (!confirm('Delete this submission?')) return;
        await deleteDoc(doc(db,'submissions',id));
        await refreshCounts();
        await load();
      });
    });
  }
</script>
</body>
</html>

