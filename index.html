<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Levels — Admin Panel</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6f8fb;
    --card:#ffffff;
    --ink:#0f1f28;
    --muted:#5b6b7a;
    --chip:#2b445b;
    --pill:#1f3140;
    --brand:#203a54;

    --ok:#18a957;
    --ok-ink:#fff;
    --warn:#f4c84a;
    --warn-ink:#2b2b2b;
    --danger:#e74c3c;
    --blue:#1f7ae0;

    --card-shadow:0 8px 24px rgba(0,0,0,.06);
    --radius:18px;
    --radius-sm:12px;
  }

  *{box-sizing:border-box}
  html,body{margin:0; background:var(--bg); color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; }
  a{color:inherit}

  .wrap{max-width:1200px; margin:32px auto; padding:0 16px;}

  /* Auth box */
  .authBox{
    max-width:440px; margin:80px auto; padding:24px; background:var(--card);
    border-radius:var(--radius); box-shadow:var(--card-shadow);
  }
  .authBox h2{margin:0 0 12px}
  .row{display:flex; gap:12px}
  .field{flex:1}
  .label{font-size:13px; color:var(--muted); margin:8px 0 6px}
  input[type="email"],input[type="password"],select,input[type="date"]{
    width:100%; border:1px solid #dde4ea; border-radius:12px; padding:10px 12px; font-size:14px;
    outline:none;
  }
  .btn{
    background:var(--brand); color:#fff; border:none; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer;
  }
  .btn:disabled{opacity:.6; cursor:progress}

  /* Top bar */
  .top{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--card-shadow);
    padding:16px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;
  }
  .who{color:var(--muted); font-size:14px}
  .filters{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  .chip{padding:8px 12px; border-radius:999px; background:#e9eef4; color:#123; font-weight:600; font-size:14px}
  .btnGhost{background:#e9eef4; color:#123; border:none; border-radius:12px; padding:10px 14px; cursor:pointer}

  /* Form Boxes (tabs) */
  .formTabs{display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin:16px 0 20px}
  .formTab{
    position:relative; background:var(--card); border-radius:var(--radius); box-shadow:var(--card-shadow);
    padding:16px; cursor:pointer; text-align:center; font-weight:700; color:#1f3140;
    transition:transform .06s ease;
  }
  .formTab:hover{transform:translateY(-1px)}
  .formTab.active{outline:3px solid #cfe2ff}
  .badge{
    position:absolute; top:8px; right:8px; background:#ff3b30; color:#fff; font-weight:700; font-size:12px;
    padding:4px 7px; border-radius:999px; min-width:22px; text-align:center;
  }

  /* List */
  .list{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--card-shadow);
    padding:0; overflow:hidden;
  }
  .listHead,.rowCard{
    display:grid; grid-template-columns: 160px 120px 1fr 220px 240px 160px; gap:12px; align-items:center;
  }
  .listHead{ padding:14px 16px; background:#f0f4f8; color:#263544; font-weight:700; }
  .rows{padding:0}

  .rowCard{
    position:relative;
    padding:14px 16px;
    border-top:1px solid #eef2f6;
    background:#fff;
    cursor:pointer;
  }
  .rowCard.warn{ background:#fff5d6; } /* yellow when action required */

  .rowCard .name{font-weight:700}
  .rowCard .subtle{color:var(--muted)}
  .rowCard .pill{
    justify-self:start;
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 12px; border-radius:999px; font-weight:700; font-size:13px; color:#fff;
  }
  .pill.red{ background:var(--danger) }
  .pill.blue{ background:var(--blue) }
  .pill.green{ background:var(--ok) }

  /* Expand section */
  .expand{ grid-column: 1 / -1; padding:16px; border-top:1px dashed #e6ebf1; display:none }
  .rowCard.expanded .expand{ display:block }

  .grid2{ display:grid; grid-template-columns: repeat(2,1fr); gap:16px; }
  .key{ color:var(--muted); font-size:13px; margin-bottom:4px}
  .value{ font-weight:600 }

  .actionsLine{ display:flex; gap:10px; margin-top:14px; align-items:center }
  .dangerBtn{ background:#fee1de; color:#a32d24; border:none; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer }
  .dangerBtn:hover{ background:#ffd2cd }

  /* Status button & dropdown */
  .statusWrap{ position:relative; display:inline-block }
  .statusBtn{ border:none; border-radius:999px; padding:8px 12px; font-weight:700; color:#fff; cursor:pointer }
  .statusBtn.red{ background:var(--danger) }
  .statusBtn.blue{ background:var(--blue) }
  .statusBtn.green{ background:var(--ok) }
  .statusMenu{
    position:absolute; left:0; top:calc(100% + 6px); background:#fff; border:1px solid #e6ebf1; border-radius:12px; box-shadow:var(--card-shadow);
    min-width:180px; padding:6px; z-index:10; display:none;
  }
  .statusWrap.open .statusMenu{ display:block }
  .statusItem{ padding:8px 10px; border-radius:10px; cursor:pointer; display:flex; align-items:center; gap:8px; }
  .statusItem:hover{ background:#f3f6fb }
  .dot{ width:10px; height:10px; border-radius:50% }
  .dot.red{ background:var(--danger) } .dot.blue{ background:var(--blue) } .dot.green{ background:var(--ok) }

  .empty{ padding:40px; text-align:center; color:var(--muted) }

  @media (max-width:1000px){
    .listHead,.rowCard{ grid-template-columns: 130px 100px 1fr 200px 200px 130px; }
  }
  @media (max-width:820px){
    .formTabs{ grid-template-columns:repeat(2,1fr) }
    .listHead{ display:none }
    .rowCard{ grid-template-columns: 1fr; gap:8px }
    .rowCard > *:not(.expand){ grid-column: 1 / -1 }
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- AUTH -->
  <div id="authBox" class="authBox" style="display:none">
    <h2>Admin sign in</h2>
    <div class="field">
      <div class="label">Email</div>
      <input id="authEmail" type="email" placeholder="admin@example.com">
    </div>
    <div class="field">
      <div class="label">Password</div>
      <input id="authPass" type="password" placeholder="••••••••">
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
      <button id="btnSignIn" class="btn">Sign in</button>
      <div id="authMsg" class="subtle"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <div class="top">
      <div class="who" id="who"></div>
      <div class="filters">
        <select id="branchSel">
          <option value="">All branches</option>
          <option value="vake">Vake</option>
          <option value="krtsanisi">Krtsanisi</option>
        </select>
        <select id="statusSel">
          <option value="">All statuses</option>
          <option value="action_required">Action required</option>
          <option value="contacted">Contacted</option>
          <option value="registered">Registered</option>
        </select>
        <input id="fromDate" type="date">
        <input id="toDate" type="date">
        <button id="btnApply" class="btnGhost">Apply</button>
        <button id="btnReset" class="btnGhost">Reset</button>
        <button id="btnCsv" class="btnGhost">Download CSV</button>
        <button id="btnSignOut" class="btn">Sign out</button>
      </div>
    </div>

    <!-- Form tabs -->
    <div id="formTabs" class="formTabs"></div>

    <!-- List -->
    <div class="list">
      <div class="listHead">
        <div>Created</div><div>Branch</div><div>Name</div><div>Form</div><div>Course / School</div><div>Status</div>
      </div>
      <div id="rows" class="rows"></div>
    </div>
  </div>
</div>

<!-- Firebase (modules) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, getDocs, getDoc, query, where, orderBy, limit, startAt, endAt, Timestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // ===== Firebase config (your project) =====
  const firebaseConfig = {
    apiKey: "AIzaSyB-vfjAb9matVnpO6BVc3xBoFHnT_xXfH0",
    authDomain: "levels-registration.firebaseapp.com",
    projectId: "levels-registration",
    storageBucket: "levels-registration.firebasestorage.app",
    messagingSenderId: "883788306190",
    appId: "1:883788306190:web:1da45dc034cca9edefa95f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ===== Constants / helpers =====
  const FORMS = [
    { key:'EnglishRegistration', title:'English Registration' },
    { key:'ArtRegistration',     title:'Art Registration' },
    { key:'SummerSchool',        title:'Summer Schools' },
    { key:'StudyAbroad',         title:'Study Abroad' },
    { key:'Corporate',           title:'Corporate Training' },
  ];
  const FORM_LABEL = Object.fromEntries(FORMS.map(f => [f.key, f.title]));
  const BR_LABEL = { vake:'Vake', krtsanisi:'Krtsanisi' };

  const STATUS_META = {
    action_required:{ label:'Action required', pill:'red',  rowWarn:true },
    contacted:      { label:'Contacted',       pill:'blue', rowWarn:false },
    registered:     { label:'Registered',      pill:'green',rowWarn:false },
  };

  const $ = sel => document.querySelector(sel);
  const fmtDate = ts => {
    if (!ts) return '';
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString('en-GB', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
  };
  const courseOf = d => d.course || d.school || '';

  // ===== Auth UI =====
  const authBox = $('#authBox');
  const appBox  = $('#app');
  const who = $('#who');

  $('#btnSignIn').addEventListener('click', async ()=>{
    const email = $('#authEmail').value.trim();
    const pass  = $('#authPass').value;
    $('#btnSignIn').disabled = true;
    $('#authMsg').textContent = '';
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(err){
      $('#authMsg').textContent = err.message || String(err);
      $('#btnSignIn').disabled = false;
    }
  });
  $('#btnSignOut').addEventListener('click', ()=>signOut(auth));

  onAuthStateChanged(auth, async user=>{
    if(!user){
      appBox.style.display='none';
      authBox.style.display='block';
      $('#btnSignIn').disabled = false;
      return;
    }
    // Require admins.email == user.email && role == "admin"
    const adminsSnap = await getDocs(query(collection(db,'admins'), where('email','==',user.email), where('role','==','admin')));
    if(adminsSnap.empty){
      alert('You are not authorized (missing /admins document with role "admin").');
      await signOut(auth);
      return;
    }

    who.textContent = `Signed in as ${user.email} (admin)`;
    authBox.style.display='none';
    appBox.style.display='block';

    // Build tabs and counts; then load list
    buildTabs();
    await refreshBadges();
    await loadList();
  });

  // ===== Tabs with badges =====
  let currentFormKey = ''; // '' = All forms
  function buildTabs(){
    const tabs = $('#formTabs'); tabs.innerHTML='';
    const make = (item, isAll=false) => {
      const el = document.createElement('div');
      el.className = 'formTab' + (currentFormKey===item.key ? ' active':'');
      el.dataset.key = item.key;
      el.textContent = item.title;
      const b = document.createElement('div');
      b.className = 'badge'; b.textContent = '0'; el.appendChild(b);
      el.addEventListener('click', async ()=>{
        currentFormKey = item.key;
        document.querySelectorAll('.formTab').forEach(t=>t.classList.remove('active'));
        el.classList.add('active');
        await loadList();
      });
      tabs.appendChild(el);
    };

    // Render all form boxes
    FORMS.forEach(make);
    // Select first by default:
    if(!currentFormKey) currentFormKey = FORMS[0].key;
    document.querySelectorAll('.formTab').forEach(t=>{
      if(t.dataset.key===currentFormKey) t.classList.add('active');
    });
  }

  async function refreshBadges(){
    // Count action_required per form
    for(const f of FORMS){
      const qs = query(
        collection(db,'submissions'),
        where('formKey','==',f.key),
        where('status','==','action_required')
      );
      const snap = await getDocs(qs);
      const el = [...document.querySelectorAll('.formTab')].find(e=>e.dataset.key===f.key);
      if(el) el.querySelector('.badge').textContent = snap.size;
    }
  }

  // ===== Filters
  $('#btnApply').addEventListener('click', loadList);
  $('#btnReset').addEventListener('click', ()=>{
    $('#branchSel').value='';
    $('#statusSel').value='';
    $('#fromDate').value='';
    $('#toDate').value='';
    loadList();
  });

  // ===== CSV
  $('#btnCsv').addEventListener('click', ()=>{
    const rows = [...document.querySelectorAll('.rowCard')].map(r=>JSON.parse(r.dataset.raw));
    if(!rows.length){ alert('No rows to export.'); return; }
    const cols = ['createdAt','branchKey','firstName','lastName','email','phoneE164','formKey','course/school','status'];
    const lines = [cols.join(',')];
    rows.forEach(d=>{
      const vals = [
        fmtDate(d.createdAt), d.branchKey||'', d.firstName||'', d.lastName||'', d.email||'', d.phoneE164||'',
        d.formKey||'', courseOf(d)||'', d.status||''
      ];
      lines.push(vals.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'submissions.csv';
    a.click();
  });

  // ===== Load list with filters
  async function loadList(){
    const rowsEl = $('#rows'); rowsEl.innerHTML = '<div class="empty">Loading…</div>';

    const branchKey = $('#branchSel').value;
    const status = $('#statusSel').value;
    const fromStr = $('#fromDate').value;
    const toStr   = $('#toDate').value;

    let q = collection(db,'submissions');

    // equality filters
    const conds = [];
    if(currentFormKey) conds.push(where('formKey','==',currentFormKey));
    if(branchKey)      conds.push(where('branchKey','==',branchKey));
    if(status)         conds.push(where('status','==',status));

    // date range
    let hasRange = false;
    if(fromStr){
      const from = Timestamp.fromDate(new Date(fromStr + 'T00:00:00'));
      conds.push(where('createdAt','>=',from));
      hasRange = true;
    }
    if(toStr){
      const to = new Date(toStr + 'T23:59:59.999');
      conds.push(where('createdAt','<=', Timestamp.fromDate(to)));
      hasRange = true;
    }

    // order by createdAt desc (matches indexes we created)
    conds.push(orderBy('createdAt','desc'));
    q = query(q, ...conds);

    try{
      const snap = await getDocs(q);
      if(snap.empty){
        rowsEl.innerHTML = '<div class="empty">No results.</div>';
      }else{
        rowsEl.innerHTML='';
        snap.forEach(docSnap => rowsEl.appendChild(renderRow(docSnap.id, docSnap.data())));
      }
    }catch(err){
      rowsEl.innerHTML = `<div class="empty" style="color:#c62828">Error: ${err.message||err}</div>`;
    }

    // Refresh badges in the background
    refreshBadges();
  }

  // ===== Render a row
  function renderRow(id, d){
    const statusMeta = STATUS_META[d.status] || STATUS_META.action_required;

    const row = document.createElement('div');
    row.className = 'rowCard' + (statusMeta.rowWarn ? ' warn' : '');
    row.dataset.id = id;
    row.dataset.raw = JSON.stringify(d);

    // collapsed columns
    const created = document.createElement('div'); created.textContent = fmtDate(d.createdAt);
    const branch  = document.createElement('div'); branch.textContent = BR_LABEL[d.branchKey] || d.branch || '';
    const name    = document.createElement('div'); name.className='name'; name.textContent = [d.firstName,d.lastName].filter(Boolean).join(' ');
    const form    = document.createElement('div'); form.textContent = FORM_LABEL[d.formKey] || d.form || '';
    const course  = document.createElement('div'); course.textContent = courseOf(d);
    const status  = document.createElement('div');
    const pill = document.createElement('span');
    pill.className = `pill ${statusMeta.pill}`;
    pill.textContent = statusMeta.label;
    status.appendChild(pill);

    row.append(created,branch,name,form,course,status);

    // expand
    const exp = document.createElement('div');
    exp.className = 'expand';
    exp.innerHTML = `
      <div class="grid2">
        <div><div class="key">Email</div><div class="value">${d.email || ''}</div></div>
        <div><div class="key">Phone</div><div class="value">${d.phoneE164 || ''}</div></div>
        <div><div class="key">Age</div><div class="value">${d.age ?? ''}</div></div>
        <div><div class="key">Message</div><div class="value">${(d.message || '').replace(/\n/g,'<br>')}</div></div>
      </div>
      <div class="actionsLine">
        <div class="statusWrap">
          <button class="statusBtn ${statusMeta.pill}" type="button">${statusMeta.label}</button>
          <div class="statusMenu">
            <div class="statusItem" data-status="action_required"><span class="dot red"></span> Action required</div>
            <div class="statusItem" data-status="contacted"><span class="dot blue"></span> Contacted</div>
            <div class="statusItem" data-status="registered"><span class="dot green"></span> Registered</div>
          </div>
        </div>
        <button class="dangerBtn" type="button">Delete</button>
      </div>
    `;
    row.appendChild(exp);

    // row toggle
    row.addEventListener('click', e=>{
      // ignore clicks on inner interactive elements
      if(e.target.closest('.statusWrap') || e.target.closest('.dangerBtn')) return;
      row.classList.toggle('expanded');
    });

    // status dropdown logic
    const wrap = exp.querySelector('.statusWrap');
    const btn  = exp.querySelector('.statusBtn');
    const menu = exp.querySelector('.statusMenu');

    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      document.querySelectorAll('.statusWrap.open').forEach(w=>w.classList.remove('open'));
      wrap.classList.toggle('open');
    });
    menu.querySelectorAll('.statusItem').forEach(it=>{
      it.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const newSt = it.dataset.status;
        await setStatus(id, newSt);
        // update UI locally
        const meta = STATUS_META[newSt];
        btn.className = `statusBtn ${meta.pill}`;
        btn.textContent = meta.label;
        pill.className = `pill ${meta.pill}`;
        pill.textContent = meta.label;
        if(meta.rowWarn) row.classList.add('warn'); else row.classList.remove('warn');
        wrap.classList.remove('open');
        refreshBadges();
      });
    });

    // delete
    exp.querySelector('.dangerBtn').addEventListener('click', async (e)=>{
      e.stopPropagation();
      if(!confirm('Delete this submission?')) return;
      await deleteDoc(doc(db,'submissions',id));
      row.remove();
      refreshBadges();
    });

    return row;
  }

  async function setStatus(id, status){
    await updateDoc(doc(db,'submissions',id), { status });
  }

</script>
</body>
</html>

