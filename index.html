<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Levels – Admin Panel</title>

<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;500;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6f8fb;
    --card:#ffffff;
    --ink:#0f1f28;
    --muted:#5c6b78;
    --soft:#e9eef4;
    --line:#e8edf3;
    --badge:#1f6feb;
    --ok:#24a148;
    --warn:#efb21a;
    --danger:#e55353;
    --pill:#0d2940;
    --radius:18px;
    --shadow:0 10px 22px rgba(0,0,0,.06);
  }

  *{ box-sizing:border-box }
  html,body{ margin:0; background:var(--bg); color:var(--ink); font-family:"Red Hat Display", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }

  .shell{ max-width:1200px; margin:28px auto 80px; padding:0 18px; }

  /* top bar */
  .bar{
    background:var(--card); border-radius:var(--radius); padding:16px 16px 14px; box-shadow:var(--shadow);
    display:flex; align-items:center; gap:12px; flex-wrap:wrap;
  }
  .bar .me{ font-weight:700; color:var(--muted); margin-right:auto; }
  .bar select, .bar input[type="date"]{
    background:#f2f5f9; border:none; border-radius:12px; padding:10px 12px; font-size:14px; color:var(--ink);
  }
  .btn{ background:var(--pill); color:#fff; border:none; padding:10px 16px; border-radius:12px; font-weight:800; cursor:pointer; }
  .btn.ghost{ background:#edf3f9; color:#0d2940; }

  /* tabs */
  .tabs{ display:flex; gap:12px; margin:18px 0; }
  .tab{
    background:var(--card); color:#0d2940; border-radius:999px; padding:10px 16px; font-weight:800;
    cursor:pointer; user-select:none; position:relative; box-shadow:var(--shadow);
  }
  .tab.active{ background:#e8f0ff; color:#1a49b8; }
  .tab .dot{
    position:absolute; top:-6px; right:-6px; min-width:22px; height:22px; padding:0 6px; border-radius:999px;
    display:flex; align-items:center; justify-content:center; background:var(--badge); color:#fff; font-size:12px; font-weight:800;
  }

  /* header row */
  .hdr{
    background:var(--card); border-radius:var(--radius); padding:18px 20px; box-shadow:var(--shadow);
    display:grid; grid-template-columns: 1.1fr .9fr 1fr 1fr 1.1fr .7fr; gap:16px; color:#637789; font-weight:700;
  }

  /* list */
  .list{ margin-top:12px; display:flex; flex-direction:column; gap:16px; }
  .row{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
  }
  .rowHead{
    display:grid; grid-template-columns: 1.1fr .9fr 1fr 1fr 1.1fr .7fr; gap:16px;
    padding:18px 20px; align-items:center; border-bottom:1px dashed var(--line); cursor:pointer;
  }
  .k{
    display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:700; color:#0d2940;
  }
  .sub{ color:var(--muted); font-weight:500; }

  .status{
    justify-self:end; position:relative;
  }
  .statusBtn{
    display:inline-flex; align-items:center; gap:8px; border:none; cursor:pointer; font-weight:800;
    padding:8px 14px; border-radius:999px; color:#fff; background:var(--danger);
  }
  .statusBtn.blue{ background:#2d7ff9 }
  .statusBtn.green{ background:var(--ok) }
  .statusMenu{
    position:absolute; top:calc(100% + 8px); right:0; background:#fff; border-radius:12px; box-shadow:var(--shadow);
    display:none; min-width:200px; overflow:hidden; z-index:5;
  }
  .statusMenu.open{ display:block; }
  .statusMenu button{
    display:block; width:100%; background:#fff; border:none; text-align:left; padding:12px 14px; cursor:pointer; font-weight:700;
  }
  .statusMenu button:hover{ background:#f4f8ff }

  /* expanded */
  .body{ padding:16px 18px; display:none; background:#fff7d6; }
  .row.action_required .body{ background:#fff7d6; }
  .bodyGrid{ display:grid; grid-template-columns: repeat(3,1fr); gap:14px; }
  .chip{
    background:#f2f6fb; border-radius:14px; padding:14px; min-height:64px;
  }
  .cap{ color:#637789; font-weight:700; margin-bottom:6px; font-size:14px; }
  .val{ font-weight:700; color:#0d2940; word-break:break-word; }
  .msg{ grid-column:1 / -1; background:#f9fcff; border-radius:14px; padding:14px; min-height:70px; }
  .foot{ display:flex; justify-content:flex-start; gap:8px; margin-top:10px; }
  .danger{ background:var(--danger)!important; }

  @media (max-width:980px){
    .hdr, .rowHead{ grid-template-columns: 1.2fr .9fr 1fr 1fr .9fr .8fr; }
    .bodyGrid{ grid-template-columns: repeat(2,1fr) }
  }
  @media (max-width:680px){
    .hdr, .rowHead{ grid-template-columns: 1fr 1fr; }
    .status{ justify-self:start }
    .bodyGrid{ grid-template-columns: 1fr }
  }
</style>
</head>
<body>
  <div class="shell">
    <!-- Top bar -->
    <div class="bar">
      <div class="me" id="who">Signed out</div>

      <select id="branchSel">
        <option value="all">All branches</option>
        <option value="Vake">Vake</option>
        <option value="Krtsanisi">Krtsanisi</option>
        <option value="ვაკე">ვაკე</option>
        <option value="კრწანისი">კრწანისი</option>
      </select>

      <select id="statusSel">
        <option value="all">All statuses</option>
        <option value="action_required">Action required</option>
        <option value="contacted">Contacted</option>
        <option value="registered">Registered</option>
      </select>

      <input type="date" id="fromDate" />
      <input type="date" id="toDate" />
      <button class="btn" id="applyBtn">Apply</button>
      <button class="btn ghost" id="resetBtn">Reset</button>

      <button class="btn" id="csvBtn">Download Excel</button>
      <button class="btn danger" id="signBtn">Sign in</button>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <div class="tab active" data-form="all">All <span class="dot" id="c_all">0</span></div>
      <div class="tab" data-form="english">English <span class="dot" id="c_english">0</span></div>
      <div class="tab" data-form="art">Art <span class="dot" id="c_art">0</span></div>
      <div class="tab" data-form="summer">Summer school <span class="dot" id="c_summer">0</span></div>
      <div class="tab" data-form="study">Study abroad <span class="dot" id="c_study">0</span></div>
      <div class="tab" data-form="corporate">Corporate <span class="dot" id="c_corporate">0</span></div>
    </div>

    <!-- Header row -->
    <div class="hdr">
      <div>Created</div>
      <div>Branch</div>
      <div>Name</div>
      <div>Form</div>
      <div>Course / School</div>
      <div class="tac">Status</div>
    </div>

    <!-- Results -->
    <div class="list" id="list"></div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
      getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      initializeFirestore, doc, getDoc, collection, query, where, orderBy, limit, startAt, endAt,
      getDocs, updateDoc, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    /* === Firebase config === */
    const firebaseConfig = {
      apiKey: "AIzaSyB-vfjAb9matVnpO6BVc3xBoFHnT_xXfH0",
      authDomain: "levels-registration.firebaseapp.com",
      projectId: "levels-registration",
      storageBucket: "levels-registration.firebasestorage.app",
      messagingSenderId: "883788306190",
      appId: "1:883788306190:web:1da45dc034cca9edefa95f"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = initializeFirestore(app, { experimentalAutoDetectLongPolling: true, useFetchStreams: false });

    /* ===== State ===== */
    let currentUser = null;
    let role = null; // 'admin'
    let activeFormTab = 'all';

    const who = document.getElementById('who');
    const signBtn = document.getElementById('signBtn');

    onAuthStateChanged(auth, async (u) => {
      currentUser = u || null;
      if(!currentUser){
        who.textContent = 'Signed out';
        signBtn.textContent = 'Sign in';
        document.getElementById('list').innerHTML = '';
        return;
      }
      // role check in /admins/{emailLower}
      const key = (currentUser.email || '').toLowerCase();
      const snap = await getDoc(doc(db, 'admins', key));
      role = snap.exists() && (snap.data().role === 'admin') ? 'admin' : null;

      if(!role){
        who.textContent = `Signed in as ${currentUser.email} — not authorized`;
        alert('You are not authorized (missing /admins/{email} with role "admin").');
        return;
      }

      who.textContent = `Signed in as ${currentUser.email} (admin)`;
      signBtn.textContent = 'Sign out';

      await refreshCounters();
      await loadRows();
    });

    signBtn.addEventListener('click', async ()=>{
      if(!currentUser){
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      }else{
        await signOut(auth);
      }
    });

    /* ===== Tabs & Filters ===== */
    const tabs = Array.from(document.querySelectorAll('.tab'));
    tabs.forEach(t => t.addEventListener('click', async ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      activeFormTab = t.dataset.form;
      await loadRows();
    }));

    document.getElementById('applyBtn').addEventListener('click', loadRows);
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      document.getElementById('branchSel').value = 'all';
      document.getElementById('statusSel').value = 'all';
      document.getElementById('fromDate').value = '';
      document.getElementById('toDate').value = '';
      loadRows();
    });

    /* ===== Helpers ===== */
    const fmtDate = (ts) => {
      if(!ts || !ts.toDate) return '-';
      const d = ts.toDate();
      return d.toLocaleDateString([], {year:'numeric', month:'2-digit', day:'2-digit'}) + ', ' +
             d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    };

    const formKeyOf = (d) => {
      const raw = (d.form || d.formId || '').toLowerCase();
      if(raw.includes('english')) return 'english';
      if(raw.includes('art')) return 'art';
      if(raw.includes('summer')) return 'summer';
      if(raw.includes('study')) return 'study';
      if(raw.includes('corporate')) return 'corporate';
      return 'other';
    };

    function statusPill(status){
      const el = document.createElement('button');
      el.className = 'statusBtn';
      el.textContent = (status==='contacted' ? 'Contacted' : status==='registered' ? 'Registered' : 'Action required');
      if(status==='contacted') el.classList.add('blue');
      if(status==='registered') el.classList.add('green');
      return el;
    }

    /* ===== Query + render ===== */
    async function loadRows(){
      if(!currentUser || role!=='admin') return;

      const list = document.getElementById('list');
      list.innerHTML = '';

      // Build query
      let q = query(collection(db, 'submissions'), orderBy('createdAt', 'desc'), limit(200));

      // Filter by form tab
      if(activeFormTab !== 'all'){
        // coarse filter by presence in form/formId text
        // (we'll still render-only matching ones just in case)
      }

      // Status filter (client-side render filter for simplicity)
      const wantStatus = document.getElementById('statusSel').value; // 'all' | 'action_required' | 'contacted' | 'registered'
      const wantBranch = document.getElementById('branchSel').value; // 'all' or specific

      // Date filters -> convert to client-side check as we may not always have composite index for every combo
      const fromVal = document.getElementById('fromDate').value;
      const toVal   = document.getElementById('toDate').value;
      const fromMs  = fromVal ? new Date(fromVal+'T00:00:00').getTime() : null;
      const toMs    = toVal   ? new Date(toVal+'T23:59:59').getTime() : null;

      const snap = await getDocs(q);
      const rows = [];
      snap.forEach(docu => rows.push({ id:docu.id, ...docu.data() }));

      // Render
      rows.forEach(d => {
        const fk = formKeyOf(d);
        if(activeFormTab!=='all' && fk!==activeFormTab) return;

        if(wantStatus!=='all' && (d.status||'action_required')!==wantStatus) return;

        if(wantBranch!=='all'){
          const b = d.branch || d.branchKey || '-';
          if(b !== wantBranch) return;
        }

        if(fromMs || toMs){
          const t = (d.createdAt && d.createdAt.toDate) ? d.createdAt.toDate().getTime() : null;
          if(fromMs && (!t || t<fromMs)) return;
          if(toMs && (!t || t>toMs)) return;
        }

        list.appendChild(renderRow(d));
      });

      if(list.children.length===0){
        const z = document.createElement('div');
        z.style.color = '#637789';
        z.style.textAlign = 'center';
        z.style.padding = '28px 0';
        z.textContent = 'No results';
        list.appendChild(z);
      }
    }

    function renderRow(d){
      const fk = formKeyOf(d);
      const row = document.createElement('div');
      row.className = 'row ' + (d.status || 'action_required');

      // TOP (summary)
      const head = document.createElement('div');
      head.className = 'rowHead';

      // Created
      const c1 = document.createElement('div');
      c1.innerHTML = `<span class="k">${fmtDate(d.createdAt)}</span>`;
      head.appendChild(c1);

      // Branch
      const c2 = document.createElement('div');
      c2.innerHTML = `<span class="k">${d.branch || '-'}</span>`;
      head.appendChild(c2);

      // Name
      const c3 = document.createElement('div');
      c3.innerHTML = `<span class="k">${[d.firstName,d.lastName].filter(Boolean).join(' ') || '-'}</span>`;
      head.appendChild(c3);

      // Form
      const c4 = document.createElement('div');
      const formLabel = fk==='english' ? 'English' :
                        fk==='art' ? 'Art' :
                        fk==='summer' ? 'Summer school' :
                        fk==='study' ? 'Study abroad' :
                        fk==='corporate' ? 'Corporate' : (d.form || d.formId || '-');
      c4.innerHTML = `<span class="k">${formLabel}</span>`;
      head.appendChild(c4);

      // Course / School (Corporate -> Organisation)
      const courseLabelValue =
        fk==='corporate' ? (d.org || '-') :
        fk==='summer'    ? (d.school || '-') :
                           (d.course || '-');

      const c5 = document.createElement('div');
      c5.innerHTML = `<span class="k">${courseLabelValue}</span>`;
      head.appendChild(c5);

      // Status + menu
      const c6 = document.createElement('div'); c6.className = 'status';
      const btn = statusPill(d.status || 'action_required');
      btn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        menu.classList.toggle('open');
      });

      const menu = document.createElement('div'); menu.className = 'statusMenu';
      [['action_required','Action required'], ['contacted','Contacted'], ['registered','Registered']].forEach(([val,txt])=>{
        const it = document.createElement('button');
        it.textContent = txt;
        it.addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          menu.classList.remove('open');
          await updateDoc(doc(db,'submissions', d.id), { status: val, updatedAt: serverTimestamp() });
          btn.className = 'statusBtn' + (val==='contacted' ? ' blue' : val==='registered' ? ' green' : '');
          btn.textContent = txt;
          row.className = 'row ' + val;
          await refreshCounters();
        });
        menu.appendChild(it);
      });

      c6.appendChild(btn);
      c6.appendChild(menu);
      head.appendChild(c6);

      // toggle expand
      head.addEventListener('click', ()=> body.style.display = (body.style.display==='block' ? 'none':'block'));
      row.appendChild(head);

      // BODY (details)
      const body = document.createElement('div'); body.className = 'body';
      const grid = document.createElement('div'); grid.className = 'bodyGrid';

      // Email
      grid.appendChild(chip('Email', d.email || '-'));
      // Phone
      grid.appendChild(chip('Phone', d.phoneE164 || '-'));
      // Language
      grid.appendChild(chip('Language', (d.lang || '-')));

      // Branch (blank for corporate is fine)
      grid.appendChild(chip('Branch', d.branch || '-'));

      // Course/School OR Organisation (corporate)
      const csLabel = fk==='corporate' ? 'Organisation' : 'Course / School';
      const csValue = fk==='corporate' ? (d.org || '-') : (fk==='summer' ? (d.school || '-') : (d.course || '-'));
      grid.appendChild(chip(csLabel, csValue));

      // Form
      grid.appendChild(chip('Form', formLabel));

      // Age
      grid.appendChild(chip('Age', (d.age!=null && d.age!=='') ? d.age : '-'));

      // Created
      grid.appendChild(chip('Created', fmtDate(d.createdAt)));

      // 🔹 Extra Corporate-only fields
      if(fk==='corporate'){
        grid.appendChild(chip('Industry', d.industry || '-'));
        grid.appendChild(chip('Group size', d.groupSize || '-'));
      }

      // Message
      const message = document.createElement('div');
      message.className = 'msg';
      message.innerHTML = `<div class="cap">Message</div><div class="val">${(d.message || '—')}</div>`;

      // footer
      const foot = document.createElement('div'); foot.className = 'foot';
      const del = document.createElement('button'); del.className = 'btn danger'; del.textContent = 'Delete';
      del.addEventListener('click', async (ev)=> {
        ev.stopPropagation();
        if(confirm('Delete this submission?')){
          await deleteDoc(doc(db,'submissions', d.id));
          row.remove();
          await refreshCounters();
        }
      });
      foot.appendChild(del);

      body.appendChild(grid);
      body.appendChild(message);
      body.appendChild(foot);
      row.appendChild(body);

      // close any open menu when clicking outside
      document.addEventListener('click', (e)=>{
        if(!c6.contains(e.target)) menu.classList.remove('open');
      });

      return row;
    }

    function chip(title, value){
      const x = document.createElement('div');
      x.className = 'chip';
      x.innerHTML = `<div class="cap">${title}</div><div class="val">${value}</div>`;
      return x;
    }

    /* ===== Counters (badges on tabs) ===== */
    async function refreshCounters(){
      const snap = await getDocs(query(collection(db,'submissions'), where('status','==','action_required')));
      const counts = { all:0, english:0, art:0, summer:0, study:0, corporate:0 };
      snap.forEach(s=>{
        const fk = formKeyOf(s.data());
        counts.all++;
        if(counts[fk]!=null) counts[fk]++;
      });
      const set = (id,v)=> document.getElementById(id).textContent = v;
      set('c_all', counts.all);
      set('c_english', counts.english);
      set('c_art', counts.art);
      set('c_summer', counts.summer);
      set('c_study', counts.study);
      set('c_corporate', counts.corporate);
    }

    /* ===== CSV Export ===== */
    document.getElementById('csvBtn').addEventListener('click', exportCsv);
    async function exportCsv(){
      const snap = await getDocs(query(collection(db,'submissions'), orderBy('createdAt','desc'), limit(1000)));
      const rows = [];
      rows.push([
        'Created','Form','Branch','First name','Last name','Email','Phone','Language','Age',
        'Course/School','Organisation','Industry','Group size','Status','Message'
      ]);
      snap.forEach(d=>{
        const v = d.data();
        const fk = formKeyOf(v);
        rows.push([
          fmtDate(v.createdAt),
          (v.form || v.formId || ''),
          v.branch || '',
          v.firstName || '',
          v.lastName || '',
          v.email || '',
          v.phoneE164 || '',
          v.lang || '',
          (v.age!=null ? v.age : ''),
          fk==='summer' ? (v.school || '') : (fk==='corporate' ? '' : (v.course || '')),
          fk==='corporate' ? (v.org || '') : '',
          fk==='corporate' ? (v.industry || '') : '',
          fk==='corporate' ? (v.groupSize || '') : '',
          v.status || 'action_required',
          (v.message || '').replace(/\n/g,' ')
        ]);
      });

      const csv = rows.map(r => r.map(x=>{
        const s = (x==null ? '' : String(x));
        if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }).join(',')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'submissions.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
  </script>
</body>
</html>


