<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel</title>

<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f7f9fb; --card:#ffffff; --ink:#0f1f28; --muted:#5a6b7b;
    --pill:#e8eef5; --border:#e6ebf0; --brand:#233e57;
    --yellow:#fff6cf; --green:#e8f6e9; --blue:#e7f0ff; --red:#ffe8e8;
    --radius:18px; --shadow:0 10px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box} html,body{margin:0;height:100%}
  body{font-family:"Red Hat Display",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}

  .wrap{max-width:1100px;margin:24px auto;padding:16px}

  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}

  /* login */
  #loginView{max-width:440px;margin:60px auto}
  #loginView h1{margin:0 0 12px}
  .input{width:100%;border:1px solid var(--border);border-radius:14px;padding:12px 14px;font-size:15px;margin:8px 0}
  .btn{border:none;border-radius:14px;padding:12px 16px;font-weight:800;background:var(--brand);color:#fff;cursor:pointer}
  .btn[disabled]{opacity:.7;cursor:progress}
  .row{display:flex;gap:12px;align-items:center;justify-content:space-between}

  /* header */
  #appHeader{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
  #filters{display:flex;gap:10px;align-items:center}
  select{border:1px solid var(--border);border-radius:12px;padding:8px 12px;background:#fff}

  /* form boxes */
  .boxes{display:grid;grid-template-columns: repeat(5, 1fr); gap:12px;margin-bottom:12px}
  .box{position:relative;border:1px solid var(--border);border-radius:16px;padding:16px;cursor:pointer;user-select:none;background:#fff;transition:transform .08s}
  .box:hover{transform:translateY(-1px)}
  .box.active{outline:2px solid var(--brand)}
  .box h3{margin:0 0 6px;font-size:16px}
  .tag{display:inline-block;background:var(--pill);color:var(--muted);border-radius:999px;padding:3px 10px;font-size:12px}
  .badge{position:absolute;top:8px;right:8px;min-width:18px;height:18px;padding:0 6px;border-radius:999px;background:#e44; color:#fff; font-size:12px; display:flex;align-items:center;justify-content:center}

  /* download bar (new, minimal) */
  #dlBar{display:flex;justify-content:flex-end;margin:8px 0 16px}
  #downloadBtn{border:none;border-radius:14px;padding:10px 14px;font-weight:800;background:#1aaf5d;color:#fff;cursor:pointer;display:none}
  #downloadBtn:hover{filter:brightness(1.05)}

  /* list */
  #list{display:flex;flex-direction:column;gap:10px}
  .item{position:relative;background:#fff;border:1px solid var(--border);border-radius:16px;overflow:visible}
  .item.yellow{background:var(--yellow)}
  .item .head{display:grid;grid-template-columns: 150px 110px 1fr 180px 160px 140px 46px; gap:8px;align-items:center;padding:12px 14px}
  .head .mono{color:var(--muted);font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:5px 10px;font-size:12px;font-weight:700;cursor:pointer}
  .pill.red{background:var(--red); color:#a10}
  .pill.blue{background:var(--blue); color:#125}
  .pill.green{background:var(--green); color:#174d17}

  .item .body{padding:14px;border-top:1px dashed var(--border)}
  .bodyGrid{display:grid;grid-template-columns: repeat(4, 1fr);gap:12px}
  .field{background:#fafcff;border:1px solid var(--border);border-radius:12px;padding:10px}
  .field b{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}

  .iconBtn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
  .actions{display:flex;gap:10px;align-items:center}

  /* status menu */
  .menu{position:absolute;z-index:50;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none}
  .menu button{display:block;width:100%;text-align:left;background:none;border:none;padding:8px 10px;border-radius:10px;cursor:pointer}
  .menu button:hover{background:#f3f6fb}

  .empty{padding:26px;text-align:center;color:var(--muted)}
  .loading{padding:26px;text-align:center}
  @media (max-width:950px){ .boxes{grid-template-columns: repeat(2, 1fr)} .item .head{grid-template-columns: 120px 90px 1fr 160px 140px 120px 40px} }
  @media (max-width:650px){ .boxes{grid-template-columns: 1fr} .bodyGrid{grid-template-columns: 1fr} }
</style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN VIEW -->
  <div id="loginView" class="card" style="display:none;">
    <h1>Admin sign in</h1>
    <input id="email" class="input" type="email" placeholder="Email" />
    <input id="password" class="input" type="password" placeholder="Password" />
    <div class="row">
      <button id="loginBtn" class="btn">Sign in</button>
      <div id="loginErr" style="color:#c33;font-size:13px;"></div>
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="appView" style="display:none;">
    <div id="appHeader">
      <div style="font-weight:800;font-size:20px;">Submissions</div>
      <div class="row">
        <div id="filters">
          <label>Branch:
            <select id="fBranch">
              <option value="ALL">All</option>
              <option value="Vake">Vake</option>
              <option value="Krtsanisi">Krtsanisi</option>
            </select>
          </label>
          <label>Status:
            <select id="fStatus">
              <option value="ALL">All</option>
              <option value="action_required">Action required</option>
              <option value="contacted">Contacted</option>
              <option value="registered">Registered</option>
            </select>
          </label>
        </div>
        <button id="logoutBtn" class="iconBtn">Sign out</button>
      </div>
    </div>

    <!-- FORM BOXES -->
    <div class="boxes">
      <div class="box" data-form="EnglishRegistration"><h3>English</h3><span class="tag">Registration</span><span class="badge" style="display:none;"></span></div>
      <div class="box" data-form="ArtRegistration"><h3>Art</h3><span class="tag">Registration</span><span class="badge" style="display:none;"></span></div>
      <div class="box" data-form="SummerSchoolRegistration"><h3>Summer school</h3><span class="tag">Registration</span><span class="badge" style="display:none;"></span></div>
      <div class="box" data-form="StudyAbroadRegistration"><h3>Study abroad</h3><span class="tag">Registration</span><span class="badge" style="display:none;"></span></div>
      <div class="box" data-form="CorporateRegistration"><h3>Corporate</h3><span class="tag">Enrollment</span><span class="badge" style="display:none;"></span></div>
    </div>

    <!-- DOWNLOAD BAR (appears when a tab is active & rows loaded) -->
    <div id="dlBar">
      <button id="downloadBtn">Download Excel</button>
    </div>

    <!-- LIST -->
    <div id="list" class="card">
      <div id="loading" class="loading">Loading…</div>
      <div id="empty" class="empty" style="display:none;">No submissions yet.</div>
    </div>
  </div>
</div>

<!-- Firebase via CDN modules -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import {
    initializeFirestore, collection, getDocs, query, where, doc, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  /* ====== CONFIG ====== */
  const firebaseConfig = {
    apiKey: "AIzaSyB-vfjAb9matVnpO6BVc3xBoFHnT_xXfH0",
    authDomain: "levels-registration.firebaseapp.com",
    projectId: "levels-registration",
    storageBucket: "levels-registration.firebasestorage.app",
    messagingSenderId: "883788306190",
    appId: "1:883788306190:web:1da45dc034cca9edefa95f"
  };
  const ADMIN_EMAIL = "levelscenter@gmail.com";

  /* ====== INIT (safer for Wix iframes) ====== */
  const app = initializeApp(firebaseConfig);
  const db  = initializeFirestore(app, { experimentalAutoDetectLongPolling: true, useFetchStreams: false });
  const auth = getAuth(app);

  /* ====== UI HOOKS ====== */
  const loginView = document.getElementById('loginView');
  const appView   = document.getElementById('appView');
  const emailEl   = document.getElementById('email');
  const passEl    = document.getElementById('password');
  const loginBtn  = document.getElementById('loginBtn');
  const loginErr  = document.getElementById('loginErr');
  const logoutBtn = document.getElementById('logoutBtn');

  const boxes   = Array.from(document.querySelectorAll('.box'));
  const listEl  = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const loadEl  = document.getElementById('loading');
  const fBranch = document.getElementById('fBranch');
  const fStatus = document.getElementById('fStatus');
  const dlBar   = document.getElementById('dlBar');
  const downloadBtn = document.getElementById('downloadBtn');

  /* ====== FORMS MAP ====== */
  const FORM_KEYS = {
    english:  "EnglishRegistration",
    art:      "ArtRegistration",
    summer:   "SummerSchoolRegistration",
    abroad:   "StudyAbroadRegistration",
    corporate:"CorporateRegistration",
  };

  let activeFormKey = FORM_KEYS.english; // default
  let currentRows = [];                  // rows currently shown (after filters)

  /* ====== AUTH ====== */
  onAuthStateChanged(auth, (user)=>{
    if(user && user.email === ADMIN_EMAIL){
      loginView.style.display = 'none';
      appView.style.display = 'block';
      refreshBadges();
      loadList();
    }else{
      appView.style.display = 'none';
      loginView.style.display = 'block';
    }
  });

  loginBtn.addEventListener('click', async ()=>{
    loginErr.textContent = '';
    loginBtn.disabled = true;
    try{
      await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
    }catch(err){
      loginErr.textContent = err?.message || String(err);
    }finally{
      loginBtn.disabled = false;
    }
  });

  logoutBtn.addEventListener('click', ()=> signOut(auth));

  /* ====== HELPERS ====== */
  const normBranch = (b, bk) => {
    if (bk === "Vake" || bk === "Krtsanisi" || bk === "-") return bk;
    if (!b) return "-";
    const v = (b||"").toLowerCase();
    if (["vake","ვაკე"].includes(v)) return "Vake";
    if (["krtsanisi","კრწანისი","krtstanisi","krts"].includes(v)) return "Krtsanisi";
    return b;
  };
  const statusPillClass = (s)=> s==="registered" ? "green" : s==="contacted" ? "blue" : "red";
  const formatDate = (ts)=>{
    if (!ts) return "-";
    try{
      const d = ts.toDate ? ts.toDate() : new Date(ts.seconds ? ts.seconds*1000 : ts);
      return d.toLocaleString();
    }catch{ return "-"; }
  };
  const toISO = (ts)=>{
    if (!ts) return "";
    try{
      const d = ts.toDate ? ts.toDate() : new Date(ts.seconds ? ts.seconds*1000 : ts);
      return d.toISOString().replace('T',' ').replace('.000Z','');
    }catch{ return ""; }
  };

  function docFormKey(d){
    return d.formKey || d.form || d.formId || "";
  }

  /* ====== BADGES (count action_required) ====== */
  async function refreshBadges(){
    const snap = await getDocs(query(collection(db,"submissions"), where("status","==","action_required")));
    const counts = { };
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const key = docFormKey(d);
      if (!key) return;
      counts[key] = (counts[key]||0) + 1;
    });
    boxes.forEach(b=>{
      const key = b.getAttribute('data-form');
      const badge = b.querySelector('.badge');
      const n = counts[key] || 0;
      badge.style.display = n>0 ? 'flex' : 'none';
      badge.textContent = n;
      b.classList.toggle('active', key===activeFormKey);
    });
  }

  /* ====== LOAD LIST ====== */
  fBranch.addEventListener('change', loadList);
  fStatus.addEventListener('change', loadList);

  boxes.forEach(b=>{
    b.addEventListener('click', ()=>{
      activeFormKey = b.getAttribute('data-form');
      boxes.forEach(x=> x.classList.toggle('active', x===b));
      loadList();
    });
  });

  async function loadList(){
    loadEl.style.display = 'block';
    emptyEl.style.display = 'none';
    listEl.querySelectorAll('.item').forEach(n=>n.remove());
    downloadBtn.style.display = 'none'; // hide until rows ready

    const [q1, q2, q3] = [
      query(collection(db,"submissions"), where("formKey","==", activeFormKey)),
      query(collection(db,"submissions"), where("form","==", activeFormKey)),
      query(collection(db,"submissions"), where("formId","==", activeFormKey)),
    ];

    const [s1, s2, s3] = await Promise.all([getDocs(q1), getDocs(q2), getDocs(q3)]);
    const map = new Map();
    [s1,s2,s3].forEach(snap=>{
      snap.forEach(docSnap => map.set(docSnap.id, { id:docSnap.id, ...docSnap.data() }));
    });

    let rows = Array.from(map.values()).map(d=>{
      const branch = normBranch(d.branch, d.branchKey);
      const status = d.status || 'action_required';
      return { ...d, _branch: branch, _status: status };
    });

    const br = fBranch.value;
    const st = fStatus.value;
    if (br !== 'ALL') rows = rows.filter(r=> r._branch === br || r._branch === '-' );
    if (st !== 'ALL') rows = rows.filter(r=> r._status === st);

    rows.sort((a,b)=>{
      const ta = a.createdAt?.toMillis?.() ?? 0;
      const tb = b.createdAt?.toMillis?.() ?? 0;
      return tb - ta;
    });

    currentRows = rows; // keep for export

    loadEl.style.display = 'none';
    if (rows.length === 0){
      emptyEl.style.display = 'block';
      await refreshBadges();
      return;
    }

    rows.forEach(d=> renderItem(d));
    await refreshBadges();

    // show download button now that a tab is active and rows are present
    downloadBtn.style.display = 'inline-block';
  }

  /* ====== RENDER ITEM ====== */
  function renderItem(d){
    const item = document.createElement('div');
    item.className = 'item' + (d._status==='action_required' ? ' yellow' : '');

    const formKey = docFormKey(d);
    const isCorporate = formKey === 'CorporateRegistration';

    const formName = (formKey
      .replace('Registration','')
      .replace('Corporate','Corporate')
      .replace('SummerSchool','Summer School')
      .replace('StudyAbroad','Study Abroad')
      .replace('English','English')
      .replace('Art','Art')
    );

    const summaryRight = isCorporate ? (d.org || '-') : (d.course || d.school || '-');

    const head = document.createElement('div');
    head.className = 'head';
    head.innerHTML = `
      <div class="mono">${formatDate(d.createdAt)}</div>
      <div>${d._branch || '-'}</div>
      <div><b>${(d.firstName||'-')} ${(d.lastName||'')}</b></div>
      <div>${formName || '-'}</div>
      <div>${summaryRight}</div>
      <div>
        <span class="pill ${statusPillClass(d._status)}" data-menu-for="${d.id}">
          ${d._status === 'registered' ? 'Registered' : d._status === 'contacted' ? 'Contacted' : 'Action required'}
        </span>
      </div>
      <div><button class="iconBtn" data-expand="${d.id}">▼</button></div>
    `;

    const menu = document.createElement('div');
    menu.className = 'menu';
    menu.id = 'menu-' + d.id;
    menu.innerHTML = `
      <button data-status="action_required">Action required</button>
      <button data-status="contacted">Contacted</button>
      <button data-status="registered">Registered</button>
    `;

    const corpExtra = isCorporate ? `
      <div class="field"><b>Organisation</b><div>${d.org || '-'}</div></div>
      <div class="field"><b>Industry</b><div>${d.industry || '-'}</div></div>
      <div class="field"><b>Group Size</b><div>${d.groupSize || '-'}</div></div>
    ` : '';

    const body = document.createElement('div');
    body.className = 'body';
    body.style.display = 'none';
    body.innerHTML = `
      <div class="bodyGrid">
        <div class="field"><b>Email</b><div>${d.email||'-'}</div></div>
        <div class="field"><b>Phone</b><div>${d.phoneE164||'-'}</div></div>
        <div class="field"><b>Language</b><div>${d.lang||'-'}</div></div>
        <div class="field"><b>Age</b><div>${d.age ?? '-'}</div></div>

        <div class="field"><b>Branch</b><div>${d._branch || '-'}</div></div>
        <div class="field"><b>Course / School</b><div>${d.course || d.school || (isCorporate ? '-' : '-')}</div></div>
        <div class="field"><b>Form</b><div>${formName || '-'}</div></div>
        <div class="field"><b>Created</b><div>${formatDate(d.createdAt)}</div></div>

        ${corpExtra}

        <div class="field" style="grid-column:1 / -1;"><b>Message</b><div>${(d.message||'-').replace(/\n/g,'<br>')}</div></div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button class="iconBtn" data-del="${d.id}">Delete</button>
      </div>
    `;

    head.querySelector(`[data-expand="${d.id}"]`).addEventListener('click', ()=>{
      const isOpen = body.style.display !== 'none';
      body.style.display = isOpen ? 'none' : 'block';
    });

    // anchored status menu under the pill
    const pill = head.querySelector(`[data-menu-for="${d.id}"]`);
    pill.addEventListener('click', ()=>{
      document.querySelectorAll('.menu').forEach(m=>{ if(m!==menu) m.style.display='none'; });
      const pillRect = pill.getBoundingClientRect();
      const itemRect = item.getBoundingClientRect();
      menu.style.left = (pillRect.left - itemRect.left) + 'px';
      menu.style.top  = (pillRect.bottom - itemRect.top + 6) + 'px';
      menu.style.display = 'block';
    });

    // status change
    menu.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const newStatus = btn.getAttribute('data-status');
        try{
          await updateDoc(doc(db,'submissions', d.id), { status:newStatus });
          d._status = newStatus;
          pill.className = 'pill ' + statusPillClass(newStatus);
          pill.textContent = newStatus==='registered' ? 'Registered' : newStatus==='contacted' ? 'Contacted' : 'Action required';
          item.classList.toggle('yellow', newStatus==='action_required');
          menu.style.display = 'none';
          await refreshBadges();
        }catch(err){ alert('Failed to update status\n\n'+(err?.message||err)); }
      });
    });

    document.addEventListener('click', (e)=>{
      if (!menu.contains(e.target) && !pill.contains(e.target)){
        menu.style.display = 'none';
      }
    });

    body.querySelector(`[data-del="${d.id}"]`).addEventListener('click', async ()=>{
      if (!confirm('Delete this submission?')) return;
      try{
        await deleteDoc(doc(db,'submissions', d.id));
        item.remove();
        await refreshBadges();
        if (!listEl.querySelector('.item')) emptyEl.style.display = 'block';
      }catch(err){ alert('Delete failed\n\n'+(err?.message||err)); }
    });

    item.appendChild(head);
    item.appendChild(menu);
    item.appendChild(body);
    listEl.appendChild(item);
  }

  /* ====== EXPORT (CSV for Excel) ====== */
  function csvEscape(v){
    if (v === null || v === undefined) return '';
    const s = String(v).replace(/\r?\n/g, ' ').replace(/"/g, '""');
    return /[",\n]/.test(s) ? `"${s}"` : s;
  }

  function downloadCSV(rows){
    if (!rows || rows.length===0) return;

    // Build a stable column set (covers all forms; Excel-friendly)
    const columns = [
      'id','form','createdAt','status','branch',
      'firstName','lastName','email','phoneE164','age','lang',
      'course','school','org','industry','groupSize','message'
    ];

    const header = columns.join(',');
    const lines = rows.map(r=>{
      const data = {
        id: r.id || '',
        form: docFormKey(r) || '',
        createdAt: toISO(r.createdAt),
        status: r._status || r.status || '',
        branch: r._branch || r.branch || '',
        firstName: r.firstName || '',
        lastName: r.lastName || '',
        email: r.email || '',
        phoneE164: r.phoneE164 || '',
        age: r.age ?? '',
        lang: r.lang || '',
        course: r.course || '',
        school: r.school || '',
        org: r.org || '',
        industry: r.industry || '',
        groupSize: r.groupSize || '',
        message: r.message || ''
      };
      return columns.map(k=> csvEscape(data[k])).join(',');
    });

    const csv = '\ufeff' + [header, ...lines].join('\n'); // BOM for Excel UTF-8
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    const formShort = (activeFormKey||'All').replace('Registration','');
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.href = URL.createObjectURL(blob);
    a.download = `submissions-${formShort}-${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  }

  downloadBtn.addEventListener('click', ()=>{
    downloadCSV(currentRows); // exports exactly what's shown (current tab + filters)
  });
</script>
</body>
</html>



